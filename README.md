# Readme for NER

## How to Create a Dataset

We use BinaryNinja to create a dataset from binaries. Run the scripts in binja/ida directory in numerical order according to the prefix of the file names. 

IDA Pro and Ghidra are alternative decompiler choices; we also provide scripts for IDA Pro here. 

After the creation is complete, the following dataset will be obtained: 

```
train/src-train-pc.txt
train/tgt-train-pc.txt
valid/src-valid-pc.txt
valid/tgt-valid-pc.txt
test/src-test-pc.txt
test/tgt-test-pc.txt
```

We give an example of a piece of data:

```
# train/src-train-pc.txt
int64_t <FUNCTION> ( int32_t arg , int64_t arg , int32_t arg ) { int32_t rdx = ( arg & <Number> ) ; int32_t rsi ; if ( rdx == <Number> ) { rsi = <Number> ; } else { rsi = <Number> ; if ( rdx != <Number> ) { return <FUNCTION> ( <Number> ) ; } } return <FUNCTION> ( arg , rsi ) ; }

# train/tgt-train-pc.txt
ftp open
```

We provide pre-processed dataset generated by ida and binja for reproduction: [gdrive](https://drive.google.com/file/d/1hxQ4wXnF6HNbvkljjiNYoy74f6tkE0TZ/view?usp=sharing)

Here, you can extract it and find the files for **train & evaluate** in `Nero_ida_pc_data` directory.

## How to train and evaluate

We use Opennmt-py==1.2.0 to train and evaluate our model.

In the directory of dataset, run the following example:

**preprocess:**

```
onmt_preprocess -train_src train/src-train-pc.txt -train_tgt train/tgt-train-pc.txt -valid_src valid/src-valid-pc.txt -valid_tgt valid/tgt-valid-pc.txt -save_data processed/data-pc -src_vocab_size 4000000 -tgt_vocab_size 40000 -src_seq_length 3000 -tgt_seq_length 30 -num_threads 8
```

**train:**

```
onmt_train -data processed/data-pc -save_model models/model_1.2.0_BiLSTM_pc -world_size 1 -gpu_ranks 0 -train_steps 200000 -learning_rate_decay 1 -optim adam -learning_rate 0.001 -save_checkpoint_steps 20000 -batch_size 64 -valid_steps 20000 -valid_batch_size 32 -master_port 23333 -log_file models/train_1.2.0_BiLSTM_pc.log
```

**evaluate:**

`mkdir results` (only first eval)

`python py_test_models.py model_1.2.0_BiLSTM_pc`
